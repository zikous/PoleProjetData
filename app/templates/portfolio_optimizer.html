{% extends "base.html" %}

{% block title %}Portfolio Optimizer - Portfolio Manager{% endblock %}

{% block content %}
<h2 class="text-3xl font-bold mb-8">Portfolio Optimizer</h2>

<div class="bg-gray-800 p-6 rounded-lg mb-8">
    <form id="optimizerForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
            <label for="tickers" class="block mb-2">Tickers (comma-separated)</label>
            <input type="text" id="tickers" name="tickers" required
                class="w-full bg-gray-700 p-2 rounded text-white focus:ring-2 focus:ring-blue-500 focus:outline-none"
                placeholder="AAPL,MSFT,GOOGL" value="AAPL,MSFT,GOOGL,AMZN" pattern="^[A-Z,\s]*$"
                title="Please enter uppercase ticker symbols separated by commas">
        </div>
        <div>
            <label for="initialCapital" class="block mb-2">Initial Capital ($)</label>
            <input type="number" id="initialCapital" name="initialCapital" required
                class="w-full bg-gray-700 p-2 rounded text-white focus:ring-2 focus:ring-blue-500 focus:outline-none"
                min="1000" max="10000000" step="1000" value="10000">
        </div>
        <div>
            <label for="startDate" class="block mb-2">Start Date</label>
            <input type="date" id="startDate" name="startDate" required
                class="w-full bg-gray-700 p-2 rounded text-white focus:ring-2 focus:ring-blue-500 focus:outline-none">
        </div>
        <div>
            <label for="endDate" class="block mb-2">End Date</label>
            <input type="date" id="endDate" name="endDate" required
                class="w-full bg-gray-700 p-2 rounded text-white focus:ring-2 focus:ring-blue-500 focus:outline-none">
        </div>
        <div>
            <label for="targetReturn" class="block mb-2">Target Return (optional, %)</label>
            <input type="number" id="targetReturn" name="targetReturn"
                class="w-full bg-gray-700 p-2 rounded text-white focus:ring-2 focus:ring-blue-500 focus:outline-none"
                step="0.1" min="0" max="100" placeholder="15">
        </div>
        <div class="flex items-end">
            <button type="submit"
                class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 focus:outline-none transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                id="submitButton">
                Optimize Portfolio
            </button>
        </div>
    </form>
</div>

<div id="loadingIndicator" class="hidden">
    <div class="flex items-center justify-center space-x-4">
        <svg class="animate-spin h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none"
            viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor"
                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
            </path>
        </svg>
        <p class="text-center text-xl">Optimizing portfolio...</p>
    </div>
</div>

<div id="errorMessage" class="hidden bg-red-600 text-white p-4 rounded-lg mb-8">
    <p class="font-bold">Error</p>
    <p id="errorText"></p>
</div>

<div id="results" class="hidden">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
        <div class="bg-gray-800 p-6 rounded-lg">
            <h3 class="text-xl font-bold mb-4">Portfolio Weights</h3>
            <div id="weightResults" class="animate-fade-in"></div>
        </div>
        <div class="bg-gray-800 p-6 rounded-lg">
            <h3 class="text-xl font-bold mb-4">Performance Summary</h3>
            <div id="performanceResults" class="animate-fade-in"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    class PortfolioOptimizer {
        constructor() {
            this.form = document.getElementById('optimizerForm');
            this.loadingIndicator = document.getElementById('loadingIndicator');
            this.results = document.getElementById('results');
            this.errorMessage = document.getElementById('errorMessage');
            this.errorText = document.getElementById('errorText');
            this.submitButton = document.getElementById('submitButton');

            this.initializeDates();
            this.setupEventListeners();
        }

        initializeDates() {
            const today = new Date();
            const oneYearAgo = new Date();
            oneYearAgo.setFullYear(today.getFullYear() - 1);

            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');

            startDateInput.value = oneYearAgo.toISOString().split('T')[0];
            startDateInput.max = today.toISOString().split('T')[0];

            endDateInput.value = today.toISOString().split('T')[0];
            endDateInput.max = today.toISOString().split('T')[0];
        }

        setupEventListeners() {
            this.form.addEventListener('submit', this.handleSubmit.bind(this));

            // Validate date ranges
            const startDate = document.getElementById('startDate');
            const endDate = document.getElementById('endDate');

            startDate.addEventListener('change', () => {
                endDate.min = startDate.value;
                this.validateDates();
            });

            endDate.addEventListener('change', () => {
                startDate.max = endDate.value;
                this.validateDates();
            });
        }

        validateDates() {
            const start = new Date(document.getElementById('startDate').value);
            const end = new Date(document.getElementById('endDate').value);
            this.submitButton.disabled = start >= end;
        }

        showError(message) {
            this.errorText.textContent = message;
            this.errorMessage.classList.remove('hidden');
            setTimeout(() => {
                this.errorMessage.classList.add('hidden');
            }, 5000);
        }

        async handleSubmit(e) {
            e.preventDefault();
            this.submitButton.disabled = true;
            this.loadingIndicator.classList.remove('hidden');
            this.results.classList.add('hidden');
            this.errorMessage.classList.add('hidden');

            const formData = {
                tickers: document.getElementById('tickers').value.split(',').map(t => t.trim()),
                initial_capital: parseFloat(document.getElementById('initialCapital').value),
                start_date: document.getElementById('startDate').value,
                end_date: document.getElementById('endDate').value,
                target_return: document.getElementById('targetReturn').value ?
                    parseFloat(document.getElementById('targetReturn').value) / 100 : null
            };

            try {
                const response = await fetch('/api/optimize-portfolio', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to optimize portfolio');
                }

                if (data.success && data.result) {
                    this.displayResults(data.result, formData.tickers);
                }
            } catch (error) {
                console.error('Error:', error);
                this.showError(error.message);
            } finally {
                this.loadingIndicator.classList.add('hidden');
                this.submitButton.disabled = false;
            }
        }

        displayResults(result, tickers) {
            this.results.classList.remove('hidden');
            this.displayWeights(result.weights, tickers);
            this.displayPerformance(result.performance);
        }

        displayWeights(weights, tickers) {
            const weightResults = document.getElementById('weightResults');
            let weightsHtml = '';

            for (const [strategy, strategyWeights] of Object.entries(weights)) {
                weightsHtml += `
                    <div class="mb-6">
                        <h4 class="font-bold mb-4 text-lg">${strategy.replace('_', ' ').toUpperCase()}</h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            ${strategyWeights.map((weight, index) => `
                                <div class="flex flex-col items-center">
                                    <div class="relative w-24 h-24">
                                        <svg class="w-24 h-24 transform -rotate-90" viewBox="0 0 100 100">
                                            <circle cx="50" cy="50" r="45" stroke="#2D3748" stroke-width="10" fill="none"></circle>
                                            <circle cx="50" cy="50" r="45" 
                                                stroke="#48BB78" 
                                                stroke-width="10" 
                                                fill="none"
                                                stroke-dasharray="${(2 * Math.PI * 45).toFixed(2)}"
                                                stroke-dashoffset="${((1 - weight) * 2 * Math.PI * 45).toFixed(2)}"
                                                class="transition-all duration-1000">
                                            </circle>
                                        </svg>
                                        <div class="absolute inset-0 flex items-center justify-center text-sm font-bold">
                                            ${(weight * 100).toFixed(1)}%
                                        </div>
                                    </div>
                                    <span class="mt-2 text-center font-medium">${tickers[index]}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            weightResults.innerHTML = weightsHtml;
        }

        displayPerformance(performance) {
            const performanceResults = document.getElementById('performanceResults');
            let performanceHtml = '';

            for (const [strategy, metrics] of Object.entries(performance)) {
                performanceHtml += `
                    <div class="mb-6 bg-gray-700 p-4 rounded-lg shadow-md">
                        <h4 class="font-bold text-lg mb-4">${strategy.replace('_', ' ').toUpperCase()}</h4>
                        <div class="grid grid-cols-2 gap-4">
                            ${Object.entries(metrics).map(([metric, value]) => `
                                <div class="bg-gray-800 p-3 rounded-lg text-center transition-all hover:bg-gray-600">
                                    <p class="text-sm text-gray-400">${metric.replace('_', ' ').toUpperCase()}</p>
                                    <p class="text-lg font-bold">
                                        ${metric === 'return' || metric === 'risk' ?
                        `${(value * 100).toFixed(2)}%` :
                        value.toFixed(2)}
                                    </p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            performanceResults.innerHTML = performanceHtml;
        }
    }

    // Initialize the optimizer when the DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
        new PortfolioOptimizer();
    });
</script>

<style>
    .animate-fade-in {
        animation: fadeIn 0.5s ease-in;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }
</style>
{% endblock %}